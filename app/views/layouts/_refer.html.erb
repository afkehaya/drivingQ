<!-- ACTIONWINS -->
<div ng-app="37609aab38c8434fb2bcfee9d46ead49App" ng-controller="37609aab38c8434fb2bcfee9d46ead49Controller">
  <div ng-click="open()"><p class="btn btn-lg btn-warning">Refer A Friend</p></div>
  <script type="text/ng-template" id="actionwins-referral-modal">
  <style>
    .text-center {
      text-align: center;
    }
    .share-modal {
      display: block;
      background-color: #ffffff;
      padding: 15px 20px 20px 20px;
      border-color: #e7eaec;
      border-style: solid solid none;
      border-width: 1px 0;
      font-family: "open sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #2f4050;
      font-size: 13px;
      overflow-x: hidden;
      line-height: 1.42857143;
      background-color: #fff;
      font-family: sans-serif;
    }
  </style>

            <div id="referral_campaign_id" value="37609aab38c8434fb2bcfee9d46ead49"></div>
            <div id="advocate" value="<%= current_user.email rescue nil %>"></div>
            <div id="aw-stack" value="rails_devise"></div>
            <div id="fb_msg" value="I'm testing out ActionWins' referral marketing software. Check out the test product they made."></div>
            <div id="twt_msg" value="We're going viral with @Action_Wins #GoViral #DMO #SaaS #DrivingQ"></div>
            <div id="li_msg" value="I'm testing out ActionWins' referral marketing software. Check out the test product they made."></div>
            <div class="share-modal text-center">
              <div style="background-color: #ffffff" class="share-modal text-center back-change">
                <h2 style="color: #3439b3" class="text-change ng-binding">Refer-A-Friend</h2>
                <p style="color: #1ddec7" class="text-change2 ng-binding">Get free access to DrivingQ For Life!</p>
                <!-- Share Buttons Should Match Button Color -->
                <p>
                  <a id="fb_share_link" title="Facebook" href="https://www.facebook.com/dialog/feed?app_id=155874904884779&amp;link={{share_link|encodeUri}}&amp;redirect_url={{share_link|encodeUri}}&amp;name={{campaign_name|encodeUri}}&amp;caption=I'm testing out ActionWins' referral marketing software. Check out the test product they made.&amp;ref=inapp&amp;picture=https://placeholdit.imgix.net/~text?txtsize=33&amp;txt=200%C3%97200&amp;w=200&amp;h=200" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-facebook fa-stack-1x"></i></span></a>
                  <a id="twt_share_link" title="Twitter" href="https://twitter.com/intent/tweet?url={{share_link|encodeUri}}&amp;text=We're going viral with @Action_Wins %23GoViral %23DMO %23SaaS %23DrivingQ" data-text="We're going viral with %40Action_Wins %23GoViral %23DMO %23SaaS %23DrivingQ"><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x"></i></span></a>
                  <a id="linkedin_share_link" title="Linkedin" href="http://www.linkedin.com/shareArticle?mini=true&amp;url={{share_link}}&amp;title=DrivingQ Demo&amp;summary=I'm testing out ActionWins' referral marketing software. Check out the test product they made.&amp;source=ActionWins" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x"></i></span></a>
                  <a title="E-mail" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i ng-click="toggleEmail()" id="email-click" class="fa fa-envelope fa-stack-1x"></i></span></a>
                </p>
                <div class="click-clip" id="aw_share_link" data-clipboard-target="#aw_share_link" data-tooltip="click to copy">{{share_link}}</div>
                <div ng-init="emailState = false" ng-show="emailState" class="email-send ng-hide">
                  <div class="form-group">
                    <p><strong>Email Address</strong> </p>
                    <input id="aw-referral-email" type="email" name="email" class="form-control" placeholder="friend@example.com" value="friend@example.com">
                  </div>
                  <div class="form-group">
                    <p><strong>Email Subject</strong> </p>
                    <input id="aw-referral-subject" type="text" name="subject" class="form-control" placeholder="This is a cool referral marketing demo" value="This is a cool referral marketing demo">
                  </div>
                  <div class="form-group">
                    <label>Email Body </label>
                    <textarea id="aw-referral-body" type="text" name="body" class="form-control ng-binding" placeholder="Hey, I'm checking out this referral marketing software called ActionWins.co. Click the link and sign up so we can test it out!" value="Hey, I'm checking out this referral marketing software called ActionWins.co. Click the link and sign up so we can test it out!">Hey, I'm checking out this referral marketing software called ActionWins.co. Click the link and sign up so we can test it out!</textarea>
                  </div>
                  <button ng-click="sendEmail()" type="Send Email" value="send" name="sub" class="button-change button-text-change btn">Send Email</button>
                </div>
                <br>
                <p>You've referred <span ng-bind="ref_count" class="ng-binding">2</span> friends</p>
              </div> <!-- background color -->
            </div> <!-- share modal text-center -->

  </script>

</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ng-dialog/0.4.0/css/ngDialog.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ng-dialog/0.4.0/css/ngDialog-theme-default.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ng-dialog/0.4.0/css/ngDialog-theme-plain.min.css"/>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ng-dialog/0.4.0/js/ngDialog.min.js"></script>
<script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
<script type="text/javascript" src="https://api.actionwins.co/angular-encode-uri.min.js"></script>

<script type="text/javascript">
  var ACTIONWINS_App = angular.module("37609aab38c8434fb2bcfee9d46ead49App", ['ngDialog', 'rt.encodeuri']);
  ACTIONWINS_App.controller("37609aab38c8434fb2bcfee9d46ead49Controller", function($scope, ngDialog, $http) {

    $scope.get_share_link = function() {
      var myscript = document.querySelector('#actionwins-referral-modal');
      var new_element = document.createElement('html');
      new_element.innerHTML = myscript.innerHTML;
      var email = new_element.querySelector('#advocate').getAttribute('value');

      if (typeof email !== "undefined") {
        $http({
          method: 'GET',
          url: 'https://api.actionwins.co/sharelink?email=' + email + '&campaign_id=' + $scope.campaign_id
        }).then(function successCallback(response) {
          if (typeof response.data !== "undefined") {
            if ((response.data === "") || (response.data === "https://actionwins.co")) {
              // probably, this is because the email in question isn't an advocate for
              // this campaign; send an explicit opt-in for the email and campaign id
              // to create an advocate, getting the share link that comes back when
              // explicitly doing opt-in.  this is our one-time best effort for this case.
              $http({
                method: 'GET',
                url: 'https://api.actionwins.co/optin?email=' + email + '&campaign_id=' + $scope.campaign_id
              }).then(function successCallback(response1) {
                if (typeof response1.data !== "undefined") {
                  $scope.share_link = response1.data;
                }
              }, function errorCallback(response1) {
                $scope.share_link = "https://actionwins.co";
              });
            } else {
              $scope.share_link = response.data;
            }
          } else {
            $scope.share_link = "https://actionwins.co";
          }
        }, function errorCallback(response) {
          $scope.share_link = "https://actionwins.co";
        });
      };
    };

    $scope.get_referral_count = function() {
      var myscript = document.querySelector('#actionwins-referral-modal');
      var new_element = document.createElement('html');
      new_element.innerHTML = myscript.innerHTML;
      var email = new_element.querySelector('#advocate').getAttribute('value');

      if (typeof email !== "undefined") {
        $http({
          method: 'GET',
          url: 'https://api.actionwins.co/ref_count?email=' + email + '&campaign_id=' + $scope.campaign_id
        }).then(function successCallback(response) {
          if (typeof response.data !== "undefined") {
            $scope.ref_count = response.data;
          } else {
            $scope.ref_count = 0;
          }
        }, function errorCallback(response) {
          $scope.ref_count = 0;
        });
      };
    };

    $scope.campaign_name = "DrivingQ Demo";
    $scope.campaign_id = '37609aab38c8434fb2bcfee9d46ead49';

    if ((typeof $scope.share_link === "undefined") || ($scope.share_link === "")) {
      $scope.get_share_link();
    }
    if ((typeof $scope.ref_count === "undefined") || ($scope.ref_count === "")) {
      $scope.get_referral_count();
    }

    $scope.sendEmail = function() {
      var advocate_email = document.querySelector('#advocate').getAttribute('value');
      var referred_email = document.querySelector('#aw-referral-email').value;
      var subject = document.querySelector('#aw-referral-subject').value;
      var body = document.querySelector('#aw-referral-body').value;

      if (typeof referred_email !== "undefined") {
        console.log('referred_email: ' + referred_email);
        $http({
          method: 'GET',
          url: 'https://api.actionwins.co/share_email?advocate=' + advocate_email + '&referred=' + referred_email + '&campaign_id=' + $scope.campaign_id + '&subject=' + subject + '&body=' + body
        }).finally(function () {
          $scope.closeThisDialog('');
        });
      };
    };

    $scope.open = function() {
      var new_dialog = ngDialog.open({
        id: 'action-wins-dialog',
        template: 'actionwins-referral-modal',
        controller: "37609aab38c8434fb2bcfee9d46ead49Controller",
        scope: $scope
      });
    };

    $scope.toggleEmail = function() {
      $scope.emailState = !$scope.emailState;
    };

    /***
    angular.element(document).ready(function () {
      $scope.get_share_link();
      $scope.get_referral_count();
    });
    ***/

  });
</script>
<!-- /ACTIONWINS -->
